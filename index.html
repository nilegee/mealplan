<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mariem's Cozy Kitchen Planner</title>
  <link href="https://fonts.googleapis.com/css?family=Pacifico:400|Baloo+2:600|Poppins:400,600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <!-- Favicons for all platforms -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">

  <meta name="theme-color" content="#ffb347">
  <style>
    :root {
      --accent: #ff9800;
      --accent-dark: #ff7b29;
      --header-bg: linear-gradient(105deg, #ffd7b5 0%, #ffb593 80%, #ffcfd0 100%);
      --header-shadow: 0 6px 24px #ffb98e33;
      --badge-bg: #fff7e3;
      --badge-text: #ff8800;
      --dish-border: #ffb684;
      --dark-bg: #20202c;
      --dark-card: #252534;
      --dark-font: #f4e9e9;
      --dark-header: #2b2b3c;
      --dark-accent: #fda860;
      --dark-shadow: 0 6px 32px #262626c1;
    }
    html, body {height: 100%; min-height: 100%;}
    body {
      font-family: 'Poppins', 'Baloo 2', sans-serif;
      background: linear-gradient(120deg,#fff7f0,#ffe9d6);
      color: #333;
      margin: 0; padding: 0;
      min-height: 100vh;
      touch-action: manipulation;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode {
      background: linear-gradient(120deg,#23232d 0%,#23232d 100%);
      color: var(--dark-font);
    }
    header {
      background: var(--header-bg);
      color: #462800;
      padding: 26px 32px 34px 32px;
      display: flex;
      align-items: center;
      gap: 38px;
      border-bottom-left-radius: 38px;
      border-bottom-right-radius: 38px;
      box-shadow: var(--header-shadow);
      position: relative;
      justify-content: center;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    body.dark-mode header {
      background: var(--dark-header);
      color: var(--dark-font);
      box-shadow: var(--dark-shadow);
    }
    .chef-img-box {
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 2px 22px #ffd4ad4a;
      padding: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 135px;
      min-height: 135px;
      transition: background 0.2s;
    }
    body.dark-mode .chef-img-box {
      background: #2a2a3c;
      box-shadow: 0 2px 22px #2226;
    }
    .chef-img-box img {
      width: 120px; height: 120px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 18px #ffb67c62;
      display: block;
      margin: 0 auto;
    }
    .header-info h1 {
      font-family: 'Pacifico', cursive;
      font-size: 2.4rem;
      margin: 0 0 4px 0;
      letter-spacing: 1px;
      color: #c65000;
      text-shadow: 0 2px 8px #ffd4ad9f;
      transition: color 0.2s, text-shadow 0.2s;
    }
    body.dark-mode .header-info h1 {
      color: var(--dark-accent);
      text-shadow: 0 2px 14px #00000040;
    }
    .header-info .badge {
      display: inline-block;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-family: 'Baloo 2', cursive;
      font-size: 1.13em;
      font-weight: bold;
      padding: 7px 18px 6px 18px;
      border-radius: 18px;
      margin-top: 2px;
      margin-bottom: 8px;
      box-shadow: 0 2px 12px #ffb98e29;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode .header-info .badge {
      background: #282837;
      color: #ffa72b;
    }
    .header-info .desc {
      font-size: 1.17em;
      color: #9a4b00;
      margin-bottom: 0;
      transition: color 0.2s;
    }
    body.dark-mode .header-info .desc {
      color: #fdb671;
    }
    .dark-toggle {
      position: absolute; top: 14px; right: 30px;
      font-size: 1.8em; background: none; border: none;
      color: #e1841e; cursor: pointer; transition: color 0.2s;
      z-index: 99;
    }
    body.dark-mode .dark-toggle { color: #ffa233; }
    .container {
      display: flex; flex: 1; min-height: 80vh;
      gap: 16px; width: 100%;
      background: transparent;
      transition: all 0.2s;
    }
    .sidebar {
      width: 290px; background: #fffdf7; border-radius: 28px 0 0 28px;
      padding: 19px 12px; box-shadow: 4px 0 22px -12px #ffc28559;
      overflow-y: auto; min-width: 180px; max-height: 85vh;
      transition: width 0.25s, background 0.2s, color 0.2s, box-shadow 0.2s;
      position: relative;
    }
    body.dark-mode .sidebar {
      background: var(--dark-card);
      color: var(--dark-font);
      box-shadow: 4px 0 22px -12px #0005;
    }
    .sidebar h3 {
      margin: 0 0 16px 0; font-weight: 700; font-size: 1.16em;
      letter-spacing: 1px;
      color: #e1841e;
      transition: color 0.2s;
    }
    body.dark-mode .sidebar h3 { color: #ffa72b;}
    #dish-add-box {
      margin-bottom: 16px;
      padding: 8px 4px 8px 0;
      border-bottom: 1.5px dashed #ffd5b3;
      display: flex; gap: 4px; align-items: center;
      position: sticky; top: 0; background: inherit; z-index: 10;
    }
    body.dark-mode #dish-add-box { border-bottom: 1.5px dashed #333;}
    #dish-add-box input {
      font-size: 1.16em;
      padding: 12px 8px;
      border: 1.5px solid #ffe1c3;
      border-radius: 8px;
      margin-right: 4px;
      outline: none;
      width: 48%;
      background: #fff;
      transition: border 0.2s, background 0.2s, color 0.2s;
    }
    body.dark-mode #dish-add-box input {
      background: #252537; color: #fff; border: 1.5px solid #37374a;
    }
    .emoji-picker-btn {
      background: #ffe2c7; border: none; font-size: 1.4em;
      border-radius: 8px; cursor: pointer; margin-right: 6px; padding: 7px 11px 7px 11px;
      transition: background 0.13s;
    }
    body.dark-mode .emoji-picker-btn {background: #332e24;}
    .emoji-picker-btn:hover {background: #ffd9a2;}
    #dish-add-box button {
      font-size: 1.25em;
      background: linear-gradient(90deg,#ff914d 65%, #ffd480 100%);
      color: #fff; font-weight: 600; border-radius: 8px; border: none;
      padding: 10px 18px; box-shadow: 0 2px 6px #ffd8b37e;
      cursor: pointer; transition: background 0.15s;
      margin: 0;
    }
    #dish-add-box button:hover { background: #ffb36e;}
    .emoji-picker {
      position: absolute; top: 55px; left: 10px; z-index: 1200;
      background: #fff; border: 2px solid #ffd480;
      border-radius: 10px; box-shadow: 0 2px 12px #ffb67c23;
      padding: 8px 10px; display: flex; flex-wrap: wrap; gap: 7px;
      max-width: 255px; min-width: 210px;
    }
    body.dark-mode .emoji-picker {background: #252534; border: 2px solid #444;}
    .emoji-picker span {
      font-size: 1.5em; cursor: pointer; border-radius: 5px; padding: 2px 7px;
      transition: background 0.12s;
    }
    .emoji-picker span:hover, .emoji-picker span.selected {background: #ffe9c9;}
    body.dark-mode .emoji-picker span:hover, .emoji-picker span.selected {background: #33323e;}
    .dish-list-custom { margin-bottom: 12px; }
    .dish {
      padding: 18px 16px; margin: 13px 0;
      background: var(--card);
      border: 2px solid var(--dish-border);
      border-radius: 16px; cursor: grab;
      font-size: 1.25em; font-weight: 500;
      box-shadow: 0 1px 9px #ffe2c380;
      display: flex; align-items: center; gap: 14px;
      transition: box-shadow 0.17s, transform 0.16s, background 0.2s, color 0.2s;
      position: relative;
      user-select: none;
      min-height: 55px;
      animation: fadein .38s cubic-bezier(.31,1.56,.51,.86);
      background: #fffdf7;
      max-width: 99vw;
      word-break: break-word;
    }
    body.dark-mode .dish {
      background: #2e2e3b; color: #f9e8e2; border: 2px solid #4e4634; box-shadow: 0 1px 11px #18181b59;
    }
    .dish.dragging {
      background: #fff7ea;
      box-shadow: 0 7px 23px #ffc2854f;
      transform: scale(1.08) rotate(-3deg);
      z-index: 2;
      opacity: 0.75;
    }
    .dish .remove-dish {
      display: inline-block; position: absolute; right: 10px; top: 10px; cursor: pointer; color: #e74c3c;
      font-size: 1.5em; background: #fff4; border: none; border-radius: 50%;
      padding: 0 7px;
      opacity: 0.88; transition: opacity 0.16s;
    }
    body.dark-mode .dish .remove-dish {background: #2e2e2e; color: #ffc285;}
    .dish:hover .remove-dish { opacity: 1;}
    @keyframes fadein {
      0% {opacity:0;transform:scale(.92);}
      100% {opacity:1;transform:scale(1);}
    }
    .meal-grid {
      flex: 1; display: flex; gap: 22px;
      padding: 27px 14px 10px 0; justify-content: space-between; overflow-x: auto;
      min-width: 0;
    }
    .day-column {
      min-width: 220px; background: var(--card);
      border: 2.5px solid #ffd9b3; border-radius: 22px; padding: 18px 10px 24px 10px;
      box-shadow: 0 2px 16px #ffd9b347;
      display: flex; flex-direction: column; gap: 18px;
      transition: box-shadow 0.22s, background 0.2s;
      position: relative;
    }
    body.dark-mode .day-column {
      background: #23232d; border-color: #3d3229; box-shadow: 0 2px 16px #16161647;
    }
    .day-column h3 {
      background: linear-gradient(90deg,#ffb347,#ffd480);
      color: #fff; font-size: 1.25em; padding: 10px 0 10px 0;
      border-radius: 11px; text-align: center; margin-bottom: 8px;
      font-weight: 700; letter-spacing: 0.8px;
      margin-top: 0;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode .day-column h3 {
      background: linear-gradient(90deg,#332d19,#9b6b33);
      color: #ffd6a2;
    }
    .meal-slot {
      min-height: 90px; background: #fffaf3;
      border: 2.8px dashed var(--accent); border-radius: 13px;
      margin: 10px 0; padding: 14px 8px;
      transition: background 0.17s, border 0.18s, color 0.18s;
      font-size: 1.13em; color: #ff9800a3;
      display: flex; flex-direction: column; gap: 13px;
      align-items: flex-start;
      animation: fadein .37s cubic-bezier(.31,1.56,.51,.86);
    }
    body.dark-mode .meal-slot {
      background: #252537; border-color: #6b5125; color: #eeb275b1;
    }
    .meal-slot.active-drop {
      background: #fff3e6;
      border-color: var(--accent-dark);
      box-shadow: 0 0 0 2px #ffecd3b5;
    }
    body.dark-mode .meal-slot.active-drop {
      background: #23232e; border-color: #e28b19;
    }
    .meal-slot .dish { margin: 8px 0;}
    .btns-top {
      margin: 18px 0 0 0; text-align: center; z-index: 2;
      display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
    }
    button {
      margin: 8px 8px 6px 0; padding: 13px 22px;
      font-size: 1.08em; border-radius: 13px; border: none;
      background: linear-gradient(90deg,#ff914d 65%, #ffd480 100%);
      color: #fff; font-weight: 600;
      box-shadow: 0 2px 8px #ffc28527;
      cursor: pointer; transition: background 0.14s, box-shadow 0.14s;
      letter-spacing: 0.17px;
      outline: none;
      min-width: 98px;
    }
    button:focus { outline: 2px solid #e1841e; }
    body.dark-mode button, body.dark-mode .btns-top button {
      background: linear-gradient(90deg,#33323e 65%, #583914 100%);
      color: #f9d6c2;
    }
    button:hover, .btns-top button:focus {
      background: linear-gradient(90deg,#ff7b29 70%, #ffc285 100%);
      box-shadow: 0 3px 14px #ffd9b3bb;
      color: #fff;
    }
    body.dark-mode button:hover, body.dark-mode .btns-top button:focus {
      background: linear-gradient(90deg,#634b2a 70%, #fcb974 100%);
      color: #1b1b24;
    }
    #trashBin {
      position:fixed;bottom:33px;right:42px;z-index:999;
      transition: transform 0.2s;
      opacity: 0.91;
      display: block;
    }
    #trashBin img {
      width: 65px; height: 65px; border-radius: 14px;
      filter: drop-shadow(0 2px 10px #ffd480d5);
      transition: box-shadow 0.22s, transform 0.22s;
    }
    #trashBin.active img {
      box-shadow: 0 0 0 6px #ffdbb3, 0 7px 35px #ff98006b;
      transform: scale(1.11);
    }
    #undoSnackbar {
      position:fixed;bottom:38px;left:50%;transform:translateX(-50%);
      background:#fff4e6;padding:17px 26px;border-radius:19px;
      box-shadow:0 2px 16px #ffd9b38f;z-index:1200;cursor:pointer;font-size:1.17em;
      color: #c96600; font-weight: 700; letter-spacing: 0.4px;
      border: 1.7px solid #ffc285;
      opacity: 0.98;
      animation: fadein .5s cubic-bezier(.31,1.56,.51,.86);
    }
    body.dark-mode #undoSnackbar {
      background: #23232d; color: #ffc285; border: 1.7px solid #ffc285;
      box-shadow: 0 2px 16px #282837;
    }
    #webResults li, #favoritesList li {
      margin: 18px 0; display: flex; align-items: center; gap: 15px;
      background: var(--card2); border-radius: 18px; padding: 16px;
      box-shadow: 0 1px 12px #ffd9b36c;
      font-size: 1.13em; font-weight: 500;
      position: relative;
      animation: fadein .5s cubic-bezier(.31,1.56,.51,.86);
      min-height: 100px;
      min-width: 0;
    }
    body.dark-mode #webResults li, body.dark-mode #favoritesList li {
      background: #292941; color: #ffe9c3;
      box-shadow: 0 2px 13px #1616286c;
    }
    #webResults img, #favoritesList img {
      width: 90px; height: 90px; border-radius: 11px; object-fit: cover; margin-right: 9px;
      box-shadow: 0 2px 8px #ffd9b333;
      background: #fff6e0;
      transition: background 0.2s;
    }
    body.dark-mode #webResults img, body.dark-mode #favoritesList img {
      background: #252537;
    }
    .remove-fav {
      margin-left: auto;
      background: none; border: none; color: #ff2e2e; font-size: 1.5em; cursor: pointer;
      padding: 3px 8px 2px 8px; border-radius: 50%;
      transition: background 0.17s;
    }
    .remove-fav:hover { background: #fff0ee;}
    body.dark-mode .remove-fav:hover { background: #3d2c28;}
    .card-title-link {
      text-decoration: none; color: var(--accent-dark);
      font-weight: 700; font-size: 1.05em;
      margin-bottom: 4px; display: inline-block;
      transition: color 0.15s;
    }
    .card-title-link:hover { color: #bc6100; text-decoration: underline;}
    body.dark-mode .card-title-link { color: #fcb974;}
    #webResults button, #favoritesList button { font-size: 1em; padding: 7px 12px; margin-left: 8px;}
    .ai-suggest {
      cursor:pointer;color:#219150;font-weight:600;background:#fffaf2;
      border-radius:6px;padding:2px 7px;margin:0 4px 0 0;
      border:1px solid #ffc28582;transition:background 0.14s;
      display:inline-block;
    }
    .ai-suggest:hover { background: #ffe6d7;}
    body.dark-mode .ai-suggest {background: #292941; color: #8ff59f; border:1px solid #36734482;}
    body.dark-mode .ai-suggest:hover {background: #324d36;}
    .legend {
      padding:13px 0 13px 0;
      border-top:2px solid #ffd9b3;
      font-size:1em;
      background:#fff3e6;
      color:#444;
      display:flex; flex-wrap: wrap;
      gap: 13px;
      justify-content:center;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode .legend {
      background: #23232d; color: #f9d6c2; border-top:2px solid #443c2e;
    }
    textarea {
      font-size: 1.18em; border-radius: 8px; border: 1.6px solid #ffc285;
      width:100%; padding: 9px;
      margin-top: 7px;
      box-sizing: border-box;
      background: #fff;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    body.dark-mode textarea {
      background: #23232d; color: #ffe5c1; border: 1.6px solid #3b2c14;
    }
    #badgeBox {
      margin: 10px 0 0 0;
      text-align: center;
      font-size: 1.13em;
      color: #ff7b29;
      font-weight: 600;
      background: #fffbe7;
      border-radius: 8px;
      padding: 8px 0;
      letter-spacing: 0.4px;
      box-shadow: 0 2px 7px #ffd48036;
      transition: background 0.2s, color 0.2s;
    }
    body.dark-mode #badgeBox {
      background: #252537; color: #ffcc70; box-shadow: 0 2px 7px #1d140c36;
    }
    #insightBox {
      margin: 7px 0 3px 0;
      padding: 10px 13px;
      font-size: 1.07em;
      background: #fffbe7;
      border-radius: 9px;
      min-height: 30px;
      color: #de8c0c;
      box-shadow: 0 1px 5px #ffd4803d;
      font-weight: 600;
      line-height: 1.55;
      letter-spacing: 0.3px;
      transition: background .18s, color .18s;
    }
    body.dark-mode #insightBox {
      background: #2e2e38; color: #ffc285; box-shadow: 0 1px 5px #1a16103d;
    }
    #insightBox b { color: #219150;}
    #insightBox .ins-badge { color:#18b441;font-weight:700;display:block;margin-top:6px; }
    @media (max-width: 900px) {
      .container { flex-direction: column; gap: 0;}
      .sidebar { width: 100%; min-width: 0; border-radius: 0 0 22px 22px; max-height: unset;}
      .day-column { min-width: 0; width: 100%;}
      .meal-grid { flex-direction: column; gap: 20px;}
      #trashBin {display: none;}
    }
    @media (max-width: 650px) {
      header {flex-direction:column;gap:14px;padding:14px 2vw 18px 2vw;}
      .chef-img-box {min-width:70px;min-height:70px;}
      .chef-img-box img {width:60px;height:60px;}
      .header-info h1 {font-size:1.27em;}
      .sidebar {padding:7px 2vw 10px 2vw;}
      .sidebar h3 {text-align: center;}
      #dish-add-box {padding:10px 0;}
      .day-column {padding:10px 2vw 12px 2vw;}
      .meal-slot {min-height:54px;}
      .dish {padding:10px 9px;font-size:1em;}
      .container {gap:0;}
      #webResults img, #favoritesList img {width:54px;height:54px;}
      .legend {font-size:.97em;}
      button, .btns-top button {padding: 10px 7px; font-size:1em; min-width: 82px;}
    }
    @media (max-width: 480px) {
      header {padding:7px 1vw 7px 1vw;}
      .header-info .desc {font-size:.98em;}
      .legend {gap:7px;}
      .sidebar, .sidebar h3 {font-size:1em;}
      .dish {font-size:0.95em;}
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    // Auto Dark Mode
    function setDarkMode(mode) {
      document.body.classList.toggle('dark-mode', mode);
      localStorage.setItem('darkMode', mode ? '1' : '0');
      document.getElementById('darkModeBtn').innerHTML = mode ? 'üåû' : 'üåô';
      document.getElementById('darkModeBtn').setAttribute('aria-label', mode ? 'Switch to light mode' : 'Switch to dark mode');
    }
    window.addEventListener('DOMContentLoaded', () => {
      let mode = localStorage.getItem('darkMode');
      if (mode === null) mode = window.matchMedia('(prefers-color-scheme: dark)').matches ? '1' : '0';
      setDarkMode(mode === '1');
    });
  </script>
</head>
<body>
  <header>
    <button id="darkModeBtn" class="dark-toggle" aria-label="Switch to dark mode" onclick="setDarkMode(!document.body.classList.contains('dark-mode'));">üåô</button>
    <div class="chef-img-box">
      <img src="Chef.jpg" alt="Chef Mariem"/>
    </div>
    <div class="header-info">
      <h1>Mariem‚Äôs Cozy Kitchen</h1>
      <div class="badge">üë©‚Äçüç≥ Head Chef: Mariem</div>
      <div class="desc">Where Love is the Secret Ingredient ‚ù§Ô∏èüç≤</div>
    </div>
  </header>
  <div class="container">
    <div class="sidebar" id="dish-list">
      <h3>Dish Library</h3>
      <div id="dish-add-box">
        <button class="emoji-picker-btn" aria-label="Pick emoji" onclick="toggleEmojiPicker(event);">üçΩÔ∏è</button>
        <input type="text" id="newDishInput" maxlength="48" placeholder="Add new dish... e.g. Avocado Salad" aria-label="Add new dish">
        <button onclick="addCustomDish()" aria-label="Add dish to library">Ôºã Add</button>
        <div id="emojiPicker" class="emoji-picker" style="display:none;"></div>
      </div>
      <div id="dishList" tabindex="0" aria-label="Dish Library List"></div>
      <button onclick="exportData()" style="margin-top:10px;font-size:1em;">‚¨áÔ∏è Export Library & Plan</button>
      <button onclick="importData()" style="margin-top:8px;font-size:1em;">‚¨ÜÔ∏è Import Backup</button>
      <input type="file" id="importFile" style="display:none;" accept=".json" onchange="handleImportFile(event)">
    </div>
    <div style="flex: 1; display: flex; flex-direction: column;">
      <div class="btns-top">
        <button id="saveBtn" aria-label="Save plan">üíæ Save Plan</button>
        <button id="loadBtn" aria-label="Load plan">üìÇ Load Plan</button>
        <button id="clearBtn" aria-label="Clear all">üßπ Clear All</button>
        <button onclick="exportToPDF()" aria-label="Export grocery list as PDF">üßæ Export Grocery List (PDF)</button>
      </div>
      <div class="meal-grid" id="mealGrid">
        <div class="day-column"><h3>Monday</h3>
          <div class="meal-slot" data-meal="Main" aria-label="Main Course Monday" tabindex="0">Main Course</div>
        </div>
        <div class="day-column"><h3>Tuesday</h3>
          <div class="meal-slot" data-meal="Main" aria-label="Main Course Tuesday" tabindex="0">Main Course</div>
        </div>
        <div class="day-column"><h3>Wednesday</h3>
          <div class="meal-slot" data-meal="Main" aria-label="Main Course Wednesday" tabindex="0">Main Course</div>
        </div>
        <div class="day-column"><h3>Thursday</h3>
          <div class="meal-slot" data-meal="Main" aria-label="Main Course Thursday" tabindex="0">Main Course</div>
        </div>
        <div class="day-column"><h3>Friday</h3>
          <div class="meal-slot" data-meal="Main" aria-label="Main Course Friday" tabindex="0">Main Course</div>
        </div>
      </div>
      <div id="insightBox" aria-live="polite"></div>
      <div id="badgeBox">üèÜ Chef of the Week: Mariem! üë©‚Äçüç≥</div>
      <div style="margin: 20px; padding: 10px; border-top: 2px dashed #ffc285; background: #fff9f3; border-radius: 13px;">
        <h3>üçΩÔ∏è Got Ingredients? Need Ideas?</h3>
        <textarea id="ingredientInput" rows="2" aria-label="Enter ingredients"></textarea>
        <button onclick="suggestMealIdeas()" aria-label="Suggest ideas based on ingredients">üîç Suggest Ideas</button>
        <div id="suggestionResults" style="margin-top: 10px; white-space: pre-line;"></div>
        <h4>üåê Web Recipe Suggestions:</h4>
        <ul id="webResults" style="list-style: none; padding-left: 0;" aria-label="Web Recipe Suggestions"></ul>
        <h4>‚≠ê Favorites:</h4>
        <ul id="favoritesList" style="list-style: none; padding-left: 0;" aria-label="Favorite Recipes"></ul>
      </div>
    </div>
  </div>
  <div id="trashBin" title="Drag here to remove">
    <img src="https://img.icons8.com/fluency/96/trash.png" alt="Remove">
  </div>
  <div class="legend">
    <div>üåø = Healthy</div>
    <div>üßÜ = Kid-friendly</div>
    <div>ü•£ = Good for digestion</div>
    <div>ü•© = Iron source</div>
    <div>üçö = Rice-based</div>
    <div>üçù = Pasta-based</div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- ===================== ALL JS: features, drag, tap-to-add, emoji picker, import/export, insights, etc. =================== -->
 <script>
    // Emoji/Icons Mapping Logic
    function autoEmojis(dishName) {
      let icons = "";
      let name = dishName.toLowerCase();
      if (/chicken|shawarma|fajita|wings|liver/.test(name)) icons += "üçó";
      if (/beef|meatball|meat|tenderloin|kofta|hawawshi|liver|steak/.test(name)) icons += "ü•©";
      if (/fish|seafood|shrimp|grilled fish|salmon|sardine/.test(name)) icons += "üêü";
      if (/pasta|spaghetti|macaroni|noodle/.test(name)) icons += "üçù";
      if (/rice|koshari|maqluba|biryani/.test(name)) icons += "üçö";
      if (/potato|baked|couscous|bread|pizza|wrap|hawawshi|sandwich/.test(name)) icons += "üçû";
      if (/molokhia|salad|lentil|leblabi|greens|veggie|vegetable|avocado|spinach/.test(name)) icons += "üåø";
      if (/soup|leblabi/.test(name)) icons += "ü•£";
      if (/kid|kids|child|baby|ball/.test(name)) icons += "üßÜ";
      if (/digest|fiber/.test(name)) icons += "ü•£";
      if (/liver/.test(name)) icons += "ü•©";
      return icons;
    }

    // Editable Dish Library
    const defaultDishes = [
      "Lentil Soup", "Meatball Soup", "Oven Shawarma + Rice", "Baked Potato Chicken",
      "Seafood Bucket + Rice", "Pasta + Shrimp", "Pasta + Chicken Balls", "Pasta + Ground Meat",
      "Molokhia (Tunisian)", "Couscous + Meat (Tunisian)", "Leblabi + Bread", "Green Salad", "Black Lentil Salad",
      "Koshari (Egyptian)", "Grilled Tenderloin + Rice", "Chicken Fajita Wrap", "Grilled Chicken Liver + Rice",
      "Grilled Beef Liver + Rice", "Pizza", "Hawawshi", "Grilled Fish"
    ];
    function getDishLibrary() {
      let custom = JSON.parse(localStorage.getItem('customDishes') || "[]");
      return [...defaultDishes, ...custom];
    }
    function setCustomDishes(arr) {
      localStorage.setItem('customDishes', JSON.stringify(arr));
    }
    function renderDishLibrary() {
      const dishBox = document.getElementById('dishList');
      dishBox.innerHTML = '';
      const custom = JSON.parse(localStorage.getItem('customDishes') || "[]");
      getDishLibrary().forEach((dish, i) => {
        const div = document.createElement('div');
        div.className = 'dish';
        div.draggable = true;
        div.textContent = `${autoEmojis(dish)} ${dish}`;
        div.ondragstart = dishDragStart;
        div.ondragend = dishDragEnd;
        if (i >= defaultDishes.length) {
          let btn = document.createElement('button');
          btn.innerHTML = '‚úñ';
          btn.className = 'remove-dish';
          btn.onclick = (e)=>{ e.stopPropagation(); removeCustomDish(i - defaultDishes.length); };
          div.appendChild(btn);
        }
        dishBox.appendChild(div);
      });
      enableDragOnDishes();
    }
    function addCustomDish() {
      let inp = document.getElementById('newDishInput');
      let dish = inp.value.trim();
      if (!dish) return;
      let custom = JSON.parse(localStorage.getItem('customDishes') || "[]");
      if (getDishLibrary().includes(dish)) {
        inp.value = '';
        toast("Already in library!");
        return;
      }
      custom.push(dish);
      setCustomDishes(custom);
      inp.value = '';
      renderDishLibrary();
      analyzePlan();
    }
    function removeCustomDish(idx) {
      let custom = JSON.parse(localStorage.getItem('customDishes') || "[]");
      custom.splice(idx, 1);
      setCustomDishes(custom);
      renderDishLibrary();
      analyzePlan();
    }

    // DRAG & DROP + Everything else
    let dragElem = null, dragSource = null, lastPlan = null, trashActive = false;
    window.addEventListener('DOMContentLoaded', ()=>{
      renderDishLibrary();
      initPlanner();
    });
    function initPlanner(){
      document.querySelectorAll('.meal-slot').forEach(slot => {
        slot.addEventListener('dragover', slotDragOver);
        slot.addEventListener('dragenter', slotDragEnter);
        slot.addEventListener('dragleave', slotDragLeave);
        slot.addEventListener('drop', slotDrop);
      });
      document.getElementById('saveBtn').onclick = savePlan;
      document.getElementById('loadBtn').onclick = loadPlan;
      document.getElementById('clearBtn').onclick = clearPlan;
      document.getElementById('trashBin').addEventListener('dragover', trashDragOver);
      document.getElementById('trashBin').addEventListener('drop', trashDrop);
      document.getElementById('trashBin').addEventListener('dragleave', trashDragLeave);
      renderFavorites();
      loadPlan();
      analyzePlan();
    }
    function enableDragOnDishes(){
      document.querySelectorAll('#dishList .dish').forEach(dish => {
        dish.draggable = true;
        dish.ondragstart = dishDragStart;
        dish.ondragend = dishDragEnd;
      });
      document.querySelectorAll('.meal-slot .dish').forEach(dish => {
        dish.draggable = true;
        dish.ondragstart = dishDragStart;
        dish.ondragend = dishDragEnd;
        if(!dish.querySelector('.remove-dish')){
          let btn = document.createElement('button');
          btn.innerHTML = '‚úñ';
          btn.className = 'remove-dish';
          btn.onclick = (e)=>{ e.stopPropagation(); dish.remove(); analyzePlan(); };
          dish.appendChild(btn);
        }
      });
    }
    function dishDragStart(e){
      dragElem = e.target;
      dragSource = e.target.parentNode;
      setTimeout(()=>dragElem.classList.add('dragging'),0);
      e.dataTransfer.effectAllowed = "move";
    }
    function dishDragEnd(e){
      if(dragElem) dragElem.classList.remove('dragging');
      dragElem = null; dragSource = null;
      document.getElementById('trashBin').classList.remove('active');
      trashActive = false;
      document.querySelectorAll('.meal-slot').forEach(slot=>slot.classList.remove('active-drop'));
    }
    function slotDragOver(e){
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    }
    function slotDragEnter(e){
      e.preventDefault();
      e.currentTarget.classList.add('active-drop');
    }
    function slotDragLeave(e){
      e.currentTarget.classList.remove('active-drop');
    }
    function slotDrop(e){
      e.preventDefault();
      let slot = e.currentTarget;
      slot.classList.remove('active-drop');
      if (dragElem && dragElem.classList.contains('dish')) {
        let newDish = dragElem.cloneNode(true);
        newDish.classList.remove('dragging');
        newDish.ondragstart = dishDragStart;
        newDish.ondragend = dishDragEnd;
        let btn = newDish.querySelector('.remove-dish');
        if(!btn){
          btn = document.createElement('button');
          btn.innerHTML = '‚úñ';
          btn.className = 'remove-dish';
          btn.onclick = (e)=>{ e.stopPropagation(); newDish.remove(); analyzePlan(); };
          newDish.appendChild(btn);
        }
        slot.appendChild(newDish);
        enableDragOnDishes();
        analyzePlan();
      }
    }
    function trashDragOver(e){
      e.preventDefault();
      document.getElementById('trashBin').classList.add('active');
      trashActive = true;
    }
    function trashDrop(e){
      e.preventDefault();
      if(dragElem && dragElem.closest('.meal-slot')){
        let fade = dragElem;
        fade.style.transition = "opacity 0.32s cubic-bezier(.31,1.56,.51,.86)";
        fade.style.opacity = 0;
        setTimeout(()=>{
          if(fade.parentNode) fade.remove();
          analyzePlan();
        },320);
      }
      document.getElementById('trashBin').classList.remove('active');
      trashActive = false;
    }
    function trashDragLeave(e){
      document.getElementById('trashBin').classList.remove('active');
      trashActive = false;
    }

    // Save/load/clear/undo, Export, Recipe Suggestion, Favorites...
    function savePlan(){
      const dayCols = document.querySelectorAll('.day-column');
      let plan = {};
      dayCols.forEach(col => {
        const day = col.querySelector('h3').textContent;
        plan[day] = {};
        col.querySelectorAll('.meal-slot').forEach(slot=>{
          const mealName = slot.dataset.meal;
          plan[day][mealName] = [];
          slot.querySelectorAll('.dish').forEach(dish => plan[day][mealName].push(dish.textContent.replace('‚úñ','').trim()));
        });
      });
      localStorage.setItem('mealPlan', JSON.stringify(plan));
      toast("Meal plan saved! ü•≥");
      analyzePlan();
    }
    function loadPlan(){
      const plan = JSON.parse(localStorage.getItem('mealPlan'));
      if (!plan) { analyzePlan(); return; }
      document.querySelectorAll('.day-column').forEach(col =>{
        const day = col.querySelector('h3').textContent;
        col.querySelectorAll('.meal-slot').forEach(slot=>{
          const mealName = slot.dataset.meal;
          slot.innerHTML = mealName;
          if(plan[day] && plan[day][mealName]){
            plan[day][mealName].forEach(dishText=>{
              const div=document.createElement('div');
              div.className='dish';
              div.textContent=dishText;
              div.draggable=true;
              div.ondragstart = dishDragStart;
              div.ondragend = dishDragEnd;
              let btn = document.createElement('button');
              btn.innerHTML = '‚úñ';
              btn.className = 'remove-dish';
              btn.onclick = (e)=>{ e.stopPropagation(); div.remove(); analyzePlan(); };
              div.appendChild(btn);
              slot.appendChild(div);
            });
          }
        });
      });
      enableDragOnDishes();
      analyzePlan();
    }
    function clearPlan(){
      lastPlan = localStorage.getItem('mealPlan');
      document.querySelectorAll('.meal-slot').forEach(slot=>{
        slot.innerHTML=slot.dataset.meal;
      });
      showUndoSnackbar();
      analyzePlan();
    }
    function showUndoSnackbar() {
      let old = document.getElementById('undoSnackbar');
      if(old) old.remove();
      let sb = document.createElement('div');
      sb.textContent = "Cleared! Click to Undo ‚¨ÖÔ∏è";
      sb.id = "undoSnackbar";
      sb.onclick = () => { if(lastPlan){ localStorage.setItem('mealPlan', lastPlan); loadPlan(); sb.remove(); }};
      document.body.appendChild(sb);
      setTimeout(()=>{ if(sb.parentNode) sb.remove(); }, 4800);
    }
    function toast(msg) {
      let t = document.createElement('div');
      t.id = 'undoSnackbar';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ if(t.parentNode) t.remove(); }, 1600);
    }
    // Export grocery PDF
    function exportToPDF(){
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF();
      doc.text("Grocery List",10,10);
      let y=20;
      const items=new Set();
      document.querySelectorAll('.meal-slot .dish').forEach(dish=>items.add(dish.textContent.replace('‚úñ','').trim()));
      let i=0;
      items.forEach(item=>{
        doc.text(`- ${item}`,10,y+i*10);
        i++;
      });
      doc.save("Grocery_List.pdf");
    }

    // Recipe Suggestion & Favorites
    function suggestMealIdeas(){
      const input=document.getElementById('ingredientInput').value.toLowerCase();
      const output=document.getElementById('suggestionResults');
      const list=document.getElementById('webResults');
      output.innerText='';
      list.innerHTML='';
      if(!input.trim()){
        output.innerText="Please enter at least one ingredient.";
        return;
      }
      let suggestions=[];
      if(input.includes('chicken')) suggestions.push("Try grilled chicken or chicken curry.");
      if(input.includes('beef')) suggestions.push("Try beef stew or kofta kebab.");
      if(input.includes('pasta')) suggestions.push("Try creamy chicken pasta.");
      output.innerText=suggestions.join('\n');
      fetchRecipesFromAPI(input);
    }
    async function fetchRecipesFromAPI(ingredients){
      const list=document.getElementById('webResults');
      list.innerHTML='üîÑ Searching...';
      try{
        const res=await fetch(`https://api.spoonacular.com/recipes/findByIngredients?ingredients=${encodeURIComponent(ingredients)}&number=5&apiKey=2036afc5ca5c4e73889d9a988c25993c`);
        const data=await res.json();
        list.innerHTML='';
        if(!data.length){
          list.innerHTML='<li>No recipes found. Try other ingredients.</li>';
          return;
        }
        data.forEach(recipe=>{
          const li=document.createElement('li');
          const a=document.createElement('a');
          a.href=`https://spoonacular.com/recipes/${recipe.title.replace(/ /g,'-')}-${recipe.id}`;
          a.target='_blank';
          a.textContent=recipe.title;
          a.className = "card-title-link";
          const img=document.createElement('img');
          img.src=recipe.image;
          img.alt=recipe.title;
          img.style="width: 120px; height: 120px; border-radius: 13px; object-fit: cover; margin-right: 12px;";
          const saveBtn=document.createElement('button');
          saveBtn.textContent='‚ù§Ô∏è Save';
          saveBtn.onclick=()=>saveFavorite(a.href,recipe.title,recipe.image);
          const addBtn=document.createElement('button');
          addBtn.textContent='‚ûï Add to Plan';
          addBtn.onclick=()=>showAddRecipeModal(recipe.title,recipe.image);
          li.appendChild(img);
          li.appendChild(a);
          li.appendChild(saveBtn);
          li.appendChild(addBtn);
          list.appendChild(li);
        });
      }catch(err){
        list.innerHTML='<li>Error fetching recipes. Check your internet or API key.</li>';
      }
    }
    function showAddRecipeModal(title, image) {
      let modal = document.createElement('div');
      modal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,24,20,0.28);display:flex;align-items:center;justify-content:center;z-index:2000;";
      modal.innerHTML = `<div style="background:#fffbe6;padding:32px 24px;border-radius:14px;box-shadow:0 2px 22px #ffd9b394;">
        <h3 style="margin:0 0 12px 0;">Add to which day?</h3>
        <img src="${image}" style="width:90px;height:90px;border-radius:10px;object-fit:cover;margin-bottom:10px;">
        <div style="margin-bottom:12px;font-weight:600;">${title}</div>
        <div id="pickDayBtns" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;"></div>
        <button onclick="document.body.removeChild(this.parentNode.parentNode)">Cancel</button>
        </div>`;
      let days = Array.from(document.querySelectorAll('.day-column h3')).map(d=>d.textContent);
      let pickBtns = modal.querySelector('#pickDayBtns');
      days.forEach(day=>{
        let btn=document.createElement('button');
        btn.textContent=day;
        btn.style="padding:7px 13px;font-size:1em;margin:2px;";
        btn.onclick=()=>{
          let slot = Array.from(document.querySelectorAll('.day-column')).find(c=>c.querySelector('h3').textContent==day).querySelector('.meal-slot');
          let div=document.createElement('div');
          div.className='dish';
          div.textContent=autoEmojis(title)+' '+title;
          div.draggable=true;
          div.ondragstart = dishDragStart;
          div.ondragend = dishDragEnd;
          let imgEl=document.createElement('img');
          imgEl.src=image;
          imgEl.alt=title;
          imgEl.style="width:38px;height:38px;object-fit:cover;border-radius:7px;margin-right:7px;vertical-align:middle;";
          div.prepend(imgEl);
          let btn = document.createElement('button');
          btn.innerHTML = '‚úñ';
          btn.className = 'remove-dish';
          btn.onclick = (e)=>{ e.stopPropagation(); div.remove(); analyzePlan(); };
          div.appendChild(btn);
          slot.appendChild(div);
          enableDragOnDishes();
          analyzePlan();
          document.body.removeChild(modal);
        };
        pickBtns.appendChild(btn);
      });
      document.body.appendChild(modal);
    }
    // Favorites management
    function saveFavorite(url,title,img){
      let favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
      if (!favorites.find(f=>f.url === url)) {
        favorites.push({title,url,img});
        localStorage.setItem('favorites',JSON.stringify(favorites));
        renderFavorites();
        toast("Saved to favorites! üíñ");
      }
    }
    function renderFavorites(){
      const favList=document.getElementById('favoritesList');
      favList.innerHTML='';
      const favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
      favorites.forEach((fav,idx)=>{
        const li = document.createElement('li');
        if(fav.img){
          const img=document.createElement('img');
          img.src=fav.img; img.alt=fav.title;
          li.appendChild(img);
        }
        const a=document.createElement('a');
        a.href=fav.url;
        a.target='_blank';
        a.textContent=fav.title;
        a.className="card-title-link";
        li.appendChild(a);
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = "üóëÔ∏è";
        removeBtn.className = "remove-fav";
        removeBtn.onclick = ()=>{removeFavorite(idx);};
        li.appendChild(removeBtn);
        favList.appendChild(li);
      });
    }
    function removeFavorite(idx){
      let favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
      favorites.splice(idx,1);
      localStorage.setItem('favorites',JSON.stringify(favorites));
      renderFavorites();
    }
    // AI-Powered Insights: As above (see previous code)
    function analyzePlan() {
      let dishes = [];
      let counts = {protein: 0, greens: 0, kids: 0, total: 0};
      let mealMap = {};
      document.querySelectorAll('.meal-slot .dish').forEach(dish => {
        let txt = dish.textContent.replace('‚úñ','').trim();
        dishes.push(txt);
        if (txt.match(/(üçó|ü•©|üêü|üçñ|üç§|üçö|üçû|ü•ò|üçù|ü¶ê)/)) counts.protein++;
        if (txt.match(/(üåø|ü•ó|ü•£)/)) counts.greens++;
        if (txt.includes('üßÜ')) counts.kids++;
        counts.total++;
        mealMap[txt] = (mealMap[txt] || 0) + 1;
      });
      let introMsg = "";
      if (counts.total === 0) {
        introMsg = "Ready to cook up some magic? Start dragging those yummy dishes, Chef Mariem! üë©‚Äçüç≥";
      } else if (counts.total >= 4) {
        introMsg = "Solid plan for the week, Mariem! üëè The family‚Äôs gonna eat like royalty.";
      } else {
        introMsg = "Great start! Just a few more dishes and you‚Äôll have a feast on your hands üòã.";
      }
      let insightMsg = "";
      if (counts.total > 0) {
        let p = Math.round(100 * counts.protein / counts.total);
        let g = Math.round(100 * counts.greens / counts.total);
        insightMsg += `Protein dishes: <b>${p}%</b>, Veggie/Healthy: <b>${g}%</b>.<br>`;
      }
      if (counts.kids < 1 && counts.total > 0) {
        insightMsg += `Low on kid-friendly dishes! Maybe add something special for Yazid & Yahya (üßÜ)?<br>`;
      }
      let repeats = Object.entries(mealMap).filter(([_, n]) => n > 1);
      if (repeats.length > 0) {
        insightMsg += `Looks like you‚Äôre doubling up: <b>${repeats.map(r=>`${r[0]} x${r[1]}`).join(', ')}</b>.<br>`;
      }
      let empties = [];
      document.querySelectorAll('.meal-slot').forEach(slot => {
        if (slot.querySelectorAll('.dish').length === 0) {
          empties.push(slot.parentElement.querySelector('h3').textContent);
        }
      });
      if (empties.length) {
        insightMsg += `Still hungry? No main course for: <b>${empties.join(', ')}</b>.<br>`;
      }
      let suggestions = [];
      if (counts.greens/counts.total < 0.3 && counts.total > 0) {
        suggestions.push("A few more veggies wouldn‚Äôt hurt‚Äîthink happy tummies and extra vitamins for the whole crew! ü•óüåø");
      }
      if (counts.kids < 1) {
        suggestions.push("Yazid and Yahya deserve some extra love‚Äîmaybe add a favorite kid dish? ü§©üßÜ");
      }
      if (counts.greens/counts.total > 0.5 && counts.protein/counts.total > 0.5 && !repeats.length && counts.total >= 5) {
        suggestions.push("Wow, balanced and creative! You‚Äôre officially a kitchen superstar, Mariem üåü.");
      }
      if (suggestions.length)
        insightMsg += `<div style="margin-top:7px;color:#ff7b29;font-weight:600;">Hey Mariem! <ul style="margin:3px 0 0 18px;">`+
          suggestions.map(s=>`<li>${s}</li>`).join('') + '</ul></div>';
      let wrap = "";
      if (counts.total > 0 && suggestions.length == 0) {
        wrap = "<span class='ins-badge'>This plan is looking delicious and well-balanced. The family will love it! üíñ</span>";
      }
      document.getElementById('insightBox').innerHTML = `<div>${introMsg}</div>${insightMsg}${wrap}`;
    }
    function suggestFromLibrary(emojis, exclude=[]) {
      let options = [];
      getDishLibrary().forEach(txt=>{
        let iconTxt = `${autoEmojis(txt)} ${txt}`;
        if (emojis && !emojis.some(e=>iconTxt.includes(e))) return;
        if (exclude && exclude.includes(iconTxt)) return;
        options.push(`<span class="ai-suggest" onclick="addSuggestedDish('${iconTxt.replace(/'/g,"\\'")}')">${iconTxt} ‚ûï</span>`);
      });
      return options.slice(0,2).join('');
    }
    function addSuggestedDish(dishText) {
      let empty = Array.from(document.querySelectorAll('.meal-slot')).find(slot=>slot.querySelectorAll('.dish').length==0);
      if(!empty) return;
      let div=document.createElement('div');
      div.className='dish';
      div.textContent=dishText;
      div.draggable=true;
      div.ondragstart = dishDragStart;
      div.ondragend = dishDragEnd;
      let btn = document.createElement('button');
      btn.innerHTML = '‚úñ';
      btn.className = 'remove-dish';
      btn.onclick = (e)=>{ e.stopPropagation(); div.remove(); analyzePlan(); };
      div.appendChild(btn);
      empty.appendChild(div);
      enableDragOnDishes();
      analyzePlan();
    }
    window.addSuggestedDish = addSuggestedDish;
  </script>

</body>
</html>
